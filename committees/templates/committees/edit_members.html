{% extends 'base.html' %}
{% load staticfiles %}
{% load check_user_group %}

{% block head %}

{% endblock head %}

{% block content %}
<!--
TODO: edit members
need frontendhalp
Use AJAX and autocomplete search field to add/remove users
  Existing scripts and autocomplete form lifted shamelessly from event attendees page
-->

  <div class="content">
      <h1> {{ committee.name }} </h1>
      <div class="card">
          <form action="toggle" method="post">
              {% csrf_token %}
              <div class="input-field user_search_field">
                  <input name="user" type="text" id="autocomplete-input" class="autocomplete" autocomplete="off">
                  <label for="autocomplete-input" id="autocomplete-text">Bruker</label>
              </div>
              <a class="waves-effect waves-light btn submit" onclick="add_person();">Legg til</a>
          </form>
      </div>
      <div class="registered_users">
        <ul class="collapsible" data-collapsible="accordion">
          <li>
            <div class="collapsible-header">Påmeldte</div>
            <div class="attendee-list collapsible-body people" id="list_of_members">
              {% for username in usernames %}
                <div id="{{ username }}_container">
                  <p class="inline user" id="{{ username }}" onclick="delete_person({{ username }});">{{ username }}</p>
                </div>
              {% endfor %}
            </div>
          </li>
        </ul>
        <script>
          $(function(){
           $('.collapsible').collapsible();
         });
        </script>
      </div>
  </div>

  <style>
      #check {
          color: var(--hs-green);
      }
      #uncheck {
          color: var(--hs-gray-li2);
      }
      .checkmark {
          vertical-align: middle;
          margin-bottom: 6px;
      }
      .inline {
          display: inline-block;
      }
      input.inline {
          float: right;
      }
      #autocomplete-text.active {
          color: #9e9e9e !important;
      }
      .content {
          display: block;
          margin-left: auto;
          margin-right: auto;
          max-width: 800px;
          padding: 50px;
      }
      .card {
          height: 150px;
          padding: 30px;
      }
      .name {
          text-transform: capitalize;
      }
      input, .input-field {
          display: inline-block;
      }
      .user_search_field {
          width: 60%;
      }
      .submit {
          width: 35%;
          margin-top: 25px;
          float: right;
      }
      .name, .username{
          display: inline-block;
          width: 200px;
      }
      .toggle {
          width: 50px;
          display: inline-block;
          float: right;
      }
      .people p {
          margin: 1px;
          padding: 1px;
      }
      .collapsible {
        background-color: #eee;
      }
      .collapsible-body {
        padding: 20px;
      }
  </style>

  <!-- These scripts should handle adding and removing members to committees-->
  <script>
      $(function() {
          $('input.autocomplete').autocomplete({
              data: {
                  {% for user in all_users %}
                      "{{ user.first_name }} {{ user.last_name }} - {{ user.username }}": null,
                  {% endfor %}
              }
          });
      });

      function delete_person(username) {
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
            }
        });
        $.ajax({
          type: "POST",
          url: '',
          data: {'name': username.innerHTML, 'action': 'delete'},
          success: function(data){
            Materialize.toast(data['message'], 4000);
            var temp = $("#autocomplete-input").val();
            $("#autocomplete-input").val('');
            if (data['success']) {
              delete_user_div(data)
              var par = $(".user[username=" + data["username"] + "]").parent();
              par.find(".checkmark").html("check_box").css("color", "var(--hs-green)");
            }
            $("#autocomplete-input").val(temp);
          }
        });
      }

      function delete_user_div(data) {
        var parent = document.getElementById("list_of_members");
        var div = document.getElementById(data['username']+"_container");
        parent.removeChild(div);
      }

      function add_person() {
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
            }
        });
        $.ajax({
          type: "POST",
          url: '',
          data: {'name': $("#autocomplete-input").val(), 'action': 'add'},
          success: function(data){
            Materialize.toast(data['message'], 4000);
            $("#autocomplete-input").val('');
            if (data['success']) {
              insert_user_div(data)
              var par = $(".user[username=" + data["username"] + "]").parent();
              par.find(".checkmark").html("check_box").css("color", "var(--hs-green)");
            }
          }
        });
      }

      function insert_user_div(data) {

          var p = document.createElement("p");
          var div = document.createElement("div");
          var usr = document.createTextNode(data['username']);
          p.appendChild(usr);
          p.setAttribute("class", "inline user");
          div.setAttribute("id", data['username']+"_container");
          p.setAttribute("id", data["username"])
          p.setAttribute("onClick", "delete_person(" + data['username'] + ");")
          div.appendChild(p);

          var element = document.getElementById("list_of_members");
          element.appendChild(div);
      }

      //Vet ikke helt hva denne gjør
      function toggle(user) {
          $.ajax({
              url: '/committees/edit_members/{{ committee.name }}/toggle/',
              data: user,
          });
      }

      // Ikke denne heller
      $(".toggle").click(function() {
          toggle($(this).attr("user"));
      });

      $(function() {
          $('input.autocomplete').autocomplete({
              data: {
                  {% for user in users %}
                      "{{ user.name }} - {{ user.username }}": null,
                  {% endfor %}
              }
          });
      });
  </script>
{% endblock content %}
